!function($){$.support.cors=!0,String.prototype.endsWith=function(str){var reg;return new RegExp(str+"$").test(this)},$.fn.tablesorter=function(){var $table=this;return this.find("th").click((function(){var idx=$(this).index();if(3!=idx){var direction=$(this).hasClass("sort_asc");$table.tablesortby(idx,direction),localStorage.setItem("sortColumn",idx+1),localStorage.setItem("sortDirectionClass",direction?"sort_desc":"sort_asc")}})),this},$.fn.retablesort=function(){var $e=this.find("thead th.sort_asc, thead th.sort_desc");return $e.length&&this.tablesortby($e.index(),$e.hasClass("sort_desc")),this},$.fn.tablesortby=function(idx,direction){var $rows=this.find("tbody tr");function elementToVal(a){var $a_elem,a_val=$(a).find("td:nth-child("+(idx+1)+")").attr("data-sort");return a_val==parseInt(a_val)?parseInt(a_val):a_val}$rows.sort((function(a,b){var a_val=elementToVal(a),b_val=elementToVal(b);if(0!=idx)return(a_val<b_val?1:a_val==b_val?0:-1)*(direction?1:-1);var a_val=$(a).find("td:nth-child("+(idx+1)+")").attr("data-sort"),b_val=$(b).find("td:nth-child("+(idx+1)+")").attr("data-sort"),a_isdir=0==a_val.indexOf("................"),b_isdir=0==b_val.indexOf("................");return a_isdir===b_isdir?(a_val<b_val?1:a_val==b_val?0:-1)*(direction?1:-1):!0===a_isdir?direction?1:-1:!0===b_isdir?direction?-1:1:void 0})),this.find("th").removeClass("sort_asc sort_desc"),$(this).find("thead th:nth-child("+(idx+1)+")").addClass(direction?"sort_desc":"sort_asc");for(var i=0;i<$rows.length;i++)this.append($rows[i]);return this.settablesortmarkers(),this},$.fn.settablesortmarkers=function(){return this.find("thead th i.glyphicon").remove(),this.find("thead th.sort_asc").append('<i class="glyphicon glyphicon-chevron-up"></i>'),this.find("thead th.sort_desc").append('<i class="glyphicon glyphicon-chevron-down"></i>'),this}}(jQuery);var qrcode=new QRCode(document.getElementById("qrcode"),{correctLevel:QRCode.CorrectLevel.L,width:268,height:268}),searchMode=localStorage.getItem("searchMode"),cacheList;function loginStatusHandler(isLogin){isLogin||$("#userBtn").html(getLan("Login"))}function tokenInvalideTooltip(){$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("TipSessionTimeout")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Known"),action:function(){}}}})}function list(){$("#searchText").val("");var $tbody=$("#filelist"),hashval=window.location.hash.substr(1);$tbody.hide().empty().append('<tr><td class="text-center" colspan="6"><br/><img height="160px" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgc3Ryb2tlPSJyZ2JhKDAsMCwwLDAuNSkiIGZpbGw9Im5vbmUiIHN0cm9rZS13aWR0aD0iNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGZyb209IjAiIHRvPSI1MDIiIC8+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hhcnJheSIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIHZhbHVlcz0iMTUwLjYgMTAwLjQ7MSAyNTA7MTUwLjYgMTAwLjQiIC8+PC9jaXJjbGU+PC9zdmc+" /><br/></td></tr>').fadeIn(),$.ajaxSetup({cache:!1});var settings={async:!0,crossDomain:!0,url:"/chfs/files?filepath="+hashval,method:"GET",headers:{"cache-control":"no-cache"}};$.ajax(settings).done((function(data){$tbody.fadeOut().empty(),$("#breadcrumb").empty().html(renderBreadcrumbs(hashval)),cacheList=data.files;var fragment=document.createDocumentFragment(),currentWritable,currentReadable;$.each(data.files,(function(index,value){fragment.appendChild(renderFileRow(value)[0])})),$tbody.append(fragment),-1!==data.currentMask.indexOf("W")?1===data.virtualRoot?$(".wrOptBtns").hide():$(".wrOptBtns").show():$(".wrOptBtns").hide(),-1!==data.currentMask.indexOf("R")?$("#searchCtrl").show():$("#searchCtrl").hide(),$("#table").retablesort(),$tbody.hide().fadeIn("normal")})).fail((function(jqXHR){$tbody.fadeOut().empty(),$("#breadcrumb").empty().html(renderBreadcrumbs(hashval)),401===jqXHR.status&&(loginStatusHandler(!1),tokenInvalideTooltip())}))}function renderFileRow(data,searchText){var path=window.location.hash.substr(1)+"/"+encodeURIComponent(data.name);searchText&&searchText.length>0&&2==searchMode&&(path=data.path);var fileurl=window.location.protocol+"//"+window.location.host+"/chfs/shared"+path;if($ico="",data.icon&&($ico=$("<img class='fileDirIcon' src='"+data.icon+"'/>")),$link=$('<a style="margin-left:3px;"/>').attr("href",data.dir?"/#"+path:"/chfs/shared"+path).attr("target",data.dir?"_self":"_blank").text(data.name),searchText&&searchText.length>0){var index=data.name.toUpperCase().indexOf(searchText.toUpperCase()),left=data.name.substr(0,index),right=data.name.substr(index+searchText.length);$link=$('<a style="margin-left:3px;"/>').attr("href",data.dir?"/#"+path:"/chfs/shared"+path).attr("target",data.dir?"_self":"_blank").html(left+'<font color="red">'+searchText+"</font>"+right)}var screenWidth=document.body.clientWidth,btnSpace="1px",btnSizeClass="btn-sm",$html;return screenWidth>=1600&&screenWidth<2200?(btnSizeClass="",btnSpace="2px"):screenWidth>=2200&&(btnSizeClass="btn-lg",btnSpace="4px"),$dwnld_link='<a href="/chfs/shared'+path+'" target="_blank" class="btn btn-success '+btnSizeClass+'" style="margin:0px 0px 0px '+btnSpace+';" title="'+getLan("Download")+'" download><i class="glyphicon glyphicon-download" /></a>',$delete_link='<button type="button" style="margin:0px 0px 0px '+btnSpace+';" class="delete btn btn-danger '+btnSizeClass+'" title="'+getLan("Delete")+'" data-dir="'+data.dir+'" data-file="'+path+'"><i class="glyphicon glyphicon-trash" /></button>',$qr_btn='<button type="button" style="margin:0px 0px 0px '+btnSpace+';"  class="qrcode btn btn-success '+btnSizeClass+'" data-toggle="modal" data-target="#qrModal" title="'+getLan("QrDownload")+'" data-file="'+fileurl+'"><i class="glyphicon glyphicon-qrcode" /></button>',$rename_btn='<button type="button" style="margin:0px 0px 0px '+btnSpace+';"  class="renamebtn btn btn-warning '+btnSizeClass+'" title="'+getLan("Rename")+'" data-file="'+path+'"><i class="glyphicon glyphicon-erase" /></button>',$edit_btn='<button type="button" style="margin:0px 0px 0px '+btnSpace+';"  class="editbtn btn btn-warning '+btnSizeClass+'" title="'+getLan("EditText")+'" data-file="'+fileurl+'"><i class="glyphicon glyphicon-edit" /></button>',$play_btn='<a href="/chfs/shared'+path+'" target="_blank" class="btn btn-success '+btnSizeClass+'" style="margin:0px 0px 0px '+btnSpace+';" title="'+getLan("Play")+'"><i class="glyphicon glyphicon-play" /></a>',$dwnld_folder_link='<a href="/chfs/downloaddir'+path+'.zip" target="_blank" style="margin:0px 0px 0px '+btnSpace+';"  class="btn btn-success '+btnSizeClass+'" title="'+getLan("PkgDownload")+'" download><i class="glyphicon glyphicon-download" /></a>',$('<tr class="fileitemTr"/>').append($('<td class="fileitem"/>').attr("data-sort",(data.dir?"................":"")+data.name).append($ico).append($link)).append($('<td class="fileitem"/>').attr("data-sort",data.dir?-1:data.size).html($("<span />").text(formatFileSize(data.size,2)))).append($('<td class="fileitem"/>').attr("data-sort",(data.dir?"................":"")+data.modified).append(data.modified)).append($('<td class="fileitem"/>').html($('<div class="btn-group" />')).append(data.dir&&!data.hasSubDir?$dwnld_folder_link:"").append(data.dir?"":$dwnld_link).append(-1!==data.guestMask.indexOf("R")&&!1===data.dir?$qr_btn:"").append(isPlayable(data)?$play_btn:"").append(-1!==data.mask.indexOf("W")?$rename_btn:"").append(isEditable(data)?$edit_btn:"").append(-1===data.mask.indexOf("D")?"":$delete_link))}function isPlayable(data){var condition1=data.mask.indexOf("R"),suffex="",lowerName=data.name.toLowerCase(),dotPos=lowerName.lastIndexOf(".");switch(-1!=dotPos&&(suffex=lowerName.substr(dotPos)),suffex){case".ogg":case".mp4":case".webm":return-1!=condition1;default:return!1}}function isEditable(data){var condition1=data.mask.indexOf("W"),condition2=data.size<=1048576,condition3=!data.dir,suffex="",lowerName=data.name.toLowerCase(),dotPos=lowerName.lastIndexOf(".");switch(-1!=dotPos&&(suffex=lowerName.substr(dotPos)),suffex){case".txt":case".log":case".ini":case".inf":case".h":case".hh":case".hpp":case".hxx":case".c":case".cpp":case".cxx":case".cc":case".m":case".mm":case".java":case".cs":case".pas":case".pp":case".inc":case".html":case".htm":case".shtml":case".shtm":case".hta":case".asp":case".aspx":case".css":case".js":case".json":case".jsm":case".jsp":case".php":case".php3":case".php4":case".php5":case".php6":case".php7":case".phps":case".phpt":case".phtml":case".xml":case".xhtml":case".xht":case".xul":case".kml":case".xaml":case".xsml":case".sh":case".bsh":case".bash":case".bat":case".cmd":case".nsi":case".nsh":case".lua":case".pl":case".pm":case".py":case".rc":case".as":case".mx":case".vb":case".vbs":case".f":case".for":case".f90":case".f95":case".f2k":case".tex":case".sql":case".nfo":case".mak":return-1!=condition1&&condition2&&condition3;default:return!1}}function formatFileSize(bytes,round){if(bytes>0){var units=["B","K","M","G","T","P","E"],pow=Math.floor(Math.log(bytes)/Math.log(1024));pow=Math.min(pow,units.length-1);var size=bytes/Math.pow(1024,pow);return Number(size.toFixed(round))+units[pow]}return""}function renderBreadcrumbs(p){path=decodeURIComponent(p);var base="",len=path.split("/").length,html="";if(""===path)html='<li class="active">'+getLan("RootPath")+"</li>";else{var parentPath="";-1!=path.indexOf("/")&&(""===(parentPath=path.slice(0,path.lastIndexOf("/")))||(parentPath=encodeURIComponent(parentPath))),html='<li><a href="#'+parentPath+'">'+getLan("ReturnParentDir")+'</a>&nbsp;&nbsp;<span style="color:darkgray;">|</span>&nbsp;&nbsp;<a href="#">'+getLan("RootPath")+"</a></li>"}return $.each(path.split("/"),(function(index,value){value&&(html+=index===len-1?'<li  class="active">'+value+"</li>":'<li><a href="#/'+base+encodeURIComponent(value)+'" >'+value+"</a></li>",base+=value+"/")})),html}null==searchMode?(localStorage.setItem("searchMode",1),searchMode=1,$("#searchText").attr("placeholder",getLan("searchMenuLocal")+"..."),$("#btnSearch").hide()):2==searchMode?($("#searchText").attr("placeholder",getLan("searchMenuGlobal")+"..."),$("#btnSearch").show()):($("#searchText").attr("placeholder",getLan("searchMenuLocal")+"..."),$("#btnSearch").hide());var clipboard=new Clipboard(document.getElementById("btnCopyDlLink"),{container:document.getElementById("qrModal")});function renameFile(oldName,newName){var form=new FormData;form.append("new",newName),form.append("old",oldName);var settings={async:!1,crossDomain:!0,url:"/chfs/rename",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(){list()})).fail((function(jqXHR){401===jqXHR.status?(loginStatusHandler(!1),tokenInvalideTooltip(),list()):403===jqXHR.status?$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("VirtualFileSystemError")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}}):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("FailFileExisted")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}function login(){var user=$("#userInput").val(),pwd=$("#pwdInput").val();if(!user||!pwd)return $.confirm({theme:"bootstrap",type:"red",title:" ",content:'<span class="fileitemTr">'+getLan("UserPwdEmpty")+"</span>",autoClose:"cancelAction|1200",typeAnimated:!0,buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}}),!1;var form=new FormData;form.append("user",user),form.append("pwd",pwd);var settings={async:!1,crossDomain:!0,url:"/chfs/session",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(data){$("#userBtn").html('<i style="color:ForestGreen">'+user+"</i>"),$("#loginModal").modal("hide"),list()})).fail((function(jqXHR){401===jqXHR.status?loginStatusHandler(!1):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("UserPwdInvalide")+"</span>",autoClose:"cancelAction|2000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}clipboard.on("success",(function(e){})),clipboard.on("error",(function(e){$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("TipCopyFail")+"</span>",autoClose:"cancelAction|2000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})})),!1===Clipboard.isSupported()&&$("#btnCopyDlLink").hide(),$("#qrModal").on("show.bs.modal",(function(event){var button,fileurl=$(event.relatedTarget).data("file");qrcode.clear(),qrcode.makeCode(fileurl),$("#btnCopyDlLink").attr("data-clipboard-text",fileurl)})),$(document).on("click",".delete",(function(){var unencode=decodeURIComponent($(this).data("file")),encoded_fileurl=$(this).data("file"),isdir=$(this).data("dir");$.confirm({title:getLan("AckWndCaption"),content:function(){var name=unencode.substring(unencode.lastIndexOf("/")+1);return name.length>60?isdir?'<span class="fileitemTr">'+getLan("DeleteDirQustionDefault")+"？</span>":'<span class="fileitemTr">'+getLan("DeleteFileQustionDefault")+"？</span>":isdir?'<span class="fileitemTr">'+getLan("DeleteDirQustionDefault")+' "'+name+'" ?</span>':'<span class="fileitemTr">'+getLan("DeleteFileQustionDefault")+' "'+name+'" ?</span>'},theme:"dark",type:"red",buttons:{confirm:{text:getLan("AckWndCaption"),btnClass:"btn-red",action:function(){var form=new FormData;form.append("filepath",encoded_fileurl);var settings={async:!0,crossDomain:!0,url:"/chfs/rmfiles",method:"DELETE",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(){list()})).fail((function(jqXHR){401===jqXHR.status?(loginStatusHandler(!1),tokenInvalideTooltip(),list()):403===jqXHR.status?$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("VirtualFileSystemError")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}}):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("FailDescriptionDef")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}},cancel:{text:getLan("Cancel"),action:function(){}}}})})),$(document).on("click",".renamebtn",(function(){var encoded_fileurl=$(this).data("file"),oldBaseName="",index=encoded_fileurl.lastIndexOf("/");-1===index&&(index=encoded_fileurl.lastIndexOf("\\")),-1!==index&&(oldBaseName=decodeURIComponent(encoded_fileurl.substr(index+1,encoded_fileurl.length-index-1)));var jc=$.confirm({title:getLan("FileRenameWndCaption"),columnClass:"col-md-6 col-md-offset-3",backgroundDismiss:!0,content:'<form action="" class="formName"><div class="form-group fileitemTr">'+getLan("OldFileName")+'：<input type="text" id="old" class="form-control"  readonly="readonly" value="'+oldBaseName+'"><br>'+getLan("NewFileName")+'：<input type="text"  id="new"  class="form-control" autofocus="autofocus"/></div></form>',buttons:{formSubmit:{text:getLan("Rename"),btnClass:"btn-blue",action:function(){var text=this.$content.find("#new").val();if(!text)return $.alert(getLan("ContentCanntEmpty")),!1;renameFile(encoded_fileurl,encodeURIComponent(text)),jc.close()}},cancel:{text:getLan("Cancel"),action:function(){}}},onContentReady:function(){$("#new").keypress((function(e){if(13==e.which){var text=$("#new").val();if(!text)return $.alert(getLan("ContentCanntEmpty")),!1;renameFile(encoded_fileurl,encodeURIComponent(text)),jc.close()}}))}})})),$("#createTextBtn").on("click",(function(){$.confirm({title:getLan("CreateText"),columnClass:"col-md-6 col-md-offset-3",backgroundDismiss:!0,content:'<form action="" class="formName"><div class="form-group fileitemTr">'+getLan("Title")+'：<br><input type="text" autofocus="autofocus" class="form-control" style="width:40%" id="title">'+getLan("Content")+'：<br><textarea id="textEditor" rows="6" class="name form-control" required /></div></form>',buttons:{formSubmit:{text:getLan("Create"),btnClass:"btn-blue",action:function(){var text=this.$content.find("#textEditor").val();if(!text)return $.alert(getLan("ContentCanntEmpty")),!1;var hashval,encoded_fileurl=window.location.hash.substr(1),form=new FormData;form.append("text",text),form.append("title",this.$content.find("#title").val()),form.append("filepath",encoded_fileurl);var settings={async:!1,crossDomain:!0,url:"/chfs/newtext",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(){list()})).fail((function(jqXHR){401===jqXHR.status?(loginStatusHandler(!1),tokenInvalideTooltip(),list()):403===jqXHR.status?$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("VirtualFileSystemError")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}}):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("FailFileExisted")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}},cancel:{text:getLan("Cancel"),action:function(){}}}})})),$(document).on("click",".editbtn",(function(){var fileurl=$(this).data("file"),isEditing=!1,jc=$.confirm({title:"",columnClass:"col-md-12",backgroundDismiss:!1,content:'<textarea id="textEditor" rows="10" class="name form-control" required >'+getLan("Loading")+"...</textarea>",onContentReady:function(){var self=this,request=new XMLHttpRequest;request.open("GET",fileurl+"?t="+new Date,!0),request.send(null),request.onreadystatechange=function(){var type;if(4===request.readyState&&200===request.status&&1!==request.getResponseHeader("Content-Type").indexOf("text")){var rows=3;for(i=0;i<request.responseText.length;i++)"\n"==request.responseText.charAt(i)&&rows++;self.setContent('<textarea id="textEditor" rows="'+rows+'" class="name form-control" autofocus="aotofocus" required >'+request.responseText+"</textarea>"),document.body.clientWidth>700?$("#textEditor").keypress((function(e){self.buttons.formSubmit.show(),isEditing=!0})):(self.buttons.formSubmit.show(),isEditing=!0)}}},buttons:{formSubmit:{text:getLan("Save"),btnClass:"btn-blue",isHidden:!0,action:function(){var hashval=window.location.hash.substr(1),searchText=$("#searchText").val();searchText&&searchText.length>0&&2==searchMode&&(hashval=(hashval=fileurl.substring(fileurl.indexOf("/chfs/shared")+12)).substring(0,hashval.lastIndexOf("/")));var filename=fileurl.substring(fileurl.lastIndexOf("/")+1),rawText=this.$content.find("#textEditor").val(),form=new FormData;form.append("text",rawText.replace(new RegExp("\n","g"),"\r\n")),form.append("filename",filename),form.append("filepath",hashval);var settings={async:!1,crossDomain:!0,url:"/chfs/updatetext",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};return $.ajax(settings).done((function(){$.confirm({theme:"Modern",type:"green",title:"",content:'<span class="fileitemTr">'+getLan("SaveOK")+"</span>",autoClose:"ok|1200",buttons:{ok:{text:"",action:function(){}}}}),document.body.clientWidth>700&&(jc.buttons.formSubmit.hide(),isEditing=!1)})).fail((function(jqXHR){401===jqXHR.status?(loginStatusHandler(!1),tokenInvalideTooltip(),list()):403===jqXHR.status?$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("VirtualFileSystemError")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}}):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("SaveFail")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})})),!1}},cancel:{text:getLan("Close"),action:function(){if(isEditing)return $.confirm({title:getLan("AckWndCaption"),content:'<span class="fileitemTr">'+getLan("CloseQustionWhenEditting")+"</span>",theme:"bootstrap",type:"red",buttons:{confirm:{text:getLan("Ack"),btnClass:"btn-red",action:function(){jc.close()}},cancel:{text:getLan("Cancel"),action:function(){}}}}),!1}}}})})),$("#userBtn").on("click",(function(){var isLogin;$("#userBtn").text()===getLan("Login")?($("#loginModal").modal("toggle"),setTimeout((function(){$("#userInput").focus(),$("#userInput").select(),$("#pwdInput").val("")}),500)):$.confirm({title:getLan("AckWndCaption"),content:'<span class="fileitemTr">'+getLan("LogoutQustion")+"</span>",theme:"bootstrap",type:"red",buttons:{confirm:{text:getLan("Ack"),btnClass:"btn-red",action:function(){var settings={async:!1,crossDomain:!0,url:"/chfs/session",method:"DELETE",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data"};$.ajax(settings).done((function(data){$("#userBtn").html(getLan("Login")),list()})).fail((function(jqXHR){$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("FailDescriptionDef")+"</span>",autoClose:"cancelAction|2000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}},cancel:{text:getLan("Cancel"),action:function(){}}}})})),$("#userInput").on("keypress",(function(event){"13"==event.keyCode&&$("#pwdInput").focus()})),$("#pwdInput").on("keypress",(function(event){"13"==event.keyCode&&login()})),$("#btnLogin").on("click",(function(){login()})),$("#inputNewDir").on("keypress",(function(event){"13"==event.keyCode&&login()}));var uppie=new Uppie;function uploadDirFun(files){var folder=files[0].webkitRelativePath.split("/")[0],hashval=window.location.hash.substr(1),encoded_fileurl=hashval+"/"+encodeURIComponent(folder),form=new FormData;form.append("filepath",encoded_fileurl);var settings={async:!1,crossDomain:!0,url:"/chfs/newdir",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(){$("#progressModal").find(".modal-content").append('<div class="modal-footer"><button type="button" class="abort btn btn-default"><i class="glyphicon glyphicon-remove"/> '+getLan("Cancel")+"</button></div>"),$("#progressModal").modal("show");var lastestPathLen=files[0].webkitRelativePath.split("/").length,relativePath=folder;$.each(files,(function(index,file){var newPath=file.webkitRelativePath.substring(0,file.webkitRelativePath.lastIndexOf("/")),ulfres;if(newPath!=relativePath&&(relativePath=newPath,createNewDirFun(hashval+"/"+encodeURIComponent(relativePath))),"401"==uploadFile(file,hashval+"/"+encodeURIComponent(relativePath)))return $("#progressModal").modal("hide"),tokenInvalideTooltip(),loginStatusHandler(!1),!1}));var $el=$("#uploadDirInput");$el.wrap("<form>").closest("form").get(0).reset(),$el.unwrap()})).fail((function(jqXHR){401===jqXHR.status?(loginStatusHandler(!1),tokenInvalideTooltip(),list()):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("FailFileExisted")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}uppie(document.documentElement,(function(event,formData,files){if(0!=files.length){for(var folder=window.location.hash.substr(1),uploadFolderName=files[0].split("/")[0],i=0;i<files.length;i++)if(files[i].split("/")[0]!==uploadFolderName){uploadFolderName=uploadFolderName+"、"+files[i].split("/")[0]+"...";break}$("#progressModal").find(".modal-content").append('<div class="modal-footer"><button type="button" class="abort btn btn-default"><i class="glyphicon glyphicon-remove"/> '+getLan("Cancel")+"</button></div>"),$("#progressModal").modal("show"),formData.append("folder",folder),files.forEach((function(path){formData.append("paths[]",path)}));var $row=renderDirUploadRow(uploadFolderName);$("#progressModal").find(".modal-body").append($row);var XHR=new XMLHttpRequest;XHR.open("POST","/chfs/upload2"),uploading_xhrs.push(XHR),XHR.upload.onprogress=function(e){e.lengthComputable&&($progress=(e.loaded/e.total*100|0)+"%",$row.find(".progress-bar").css("width",$progress).text($progress))},XHR.onreadystatechange=function(){4==XHR.readyState&&(201==XHR.status&&($row.removeClass("uploading").find(".progress-bar").removeClass("active").addClass("progress-bar-success").text(getLan("UploadOK")),$row.parent().find(".uploading").length<1&&($row.parent().find(".error").length<1&&window.setTimeout((function(){$("#progressModal").modal("hide")}),2e3),list())),$row.parent().find(".uploading").length<1&&$("#progressModal").find(".abort").text(getLan("Close")),403===XHR.status&&($("#progressModal").modal("hide"),$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("HaveNoUploadPermission")+"</span>",autoClose:"cancelAction|2000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})))},XHR.send(formData)}})),$(window).bind("dragover",(function(e){var ev;return(e||window.event).preventDefault(),$("body").css("background-color","gray"),$("#maincontainer").css("border","2px dashed skyblue"),!1})),$(window).bind("dragleave",(function(){return $("body").css("background-color","#e2e2e2"),$("#maincontainer").css("border",""),!1})),$(window).bind("drop",(function(e){e.preventDefault(),$("body").css("background-color","#e2e2e2"),$("#maincontainer").css("border","")})),$("#uploadFileInput").change((function(e){e.preventDefault(),this.files.length&&($("#progressModal").find(".modal-content").append('<div class="modal-footer"><button type="button" class="abort btn btn-default"><i class="glyphicon glyphicon-remove"/> '+getLan("Cancel")+"</button></div>"),$("#progressModal").modal("show")),$.each(this.files,(function(index,file){var ulfres;if("401"==uploadFile(file,window.location.hash.substr(1)))return $("#progressModal").modal("hide"),tokenInvalideTooltip(),loginStatusHandler(!1),!1}));var $el=$("#uploadFileInput");$el.wrap("<form>").closest("form").get(0).reset(),$el.unwrap()})),$("#uploadDirInput").change((function(e){e.preventDefault();var files=e.target.files;0!=files.length&&uploadDirFun(files)})),$("#progressModal").on("hidden.bs.modal",(function(){$("#progressModal").find(".modal-footer").remove(),$("#progressModal").find(".modal-body > div").each((function(){$(this).remove()}))}));var uploading_xhrs=new Array;$(document).on("click",".abort",(function(e){var indicator;if($("#progressModal").find(".abort").text()===getLan("Close"))$("#progressModal").modal("hide");else{for(i=0;i<uploading_xhrs.length;i++)uploading_xhrs[i].abort();uploading_xhrs=new Array,$("#progressModal").find(".modal-body").find(".uploading").each((function(){$(this).find(".progress-bar").removeClass("active").addClass("progress-bar-danger").text(getLan("Canceled"))})),$("#progressModal").find(".abort").text(getLan("Close"))}}));var MAX_UPLOAD_SIZE=1e12;function uploadFile(file,folder){if(file.size>MAX_UPLOAD_SIZE){var $error_row=renderFileSizeErrorRow(file,folder);return $("#progressModal").find(".modal-body").append($error_row),"error"}var res="",settings={async:!1,crossDomain:!0,url:"/chfs/exist?file="+folder+"/"+encodeURIComponent(file.name),method:"GET",headers:{"cache-control":"no-cache"}};return $.ajax(settings).done((function(data,textStatus,xhr){var $row=renderErrorRow(file,getLan("FileExist"));$("#progressModal").find(".modal-body").append($row),$row.removeClass("uploading").find(".progress-bar").removeClass("active").addClass("progress-bar-danger"),$row.parent().find(".uploading").length<1&&$("#progressModal").find(".abort").text(getLan("Close")),res="exist"})).fail((function(jqXHR){if(401==jqXHR.status)res="401";else if(403==jqXHR.status){var $row=renderErrorRow(file,getLan("VirtualFileSystemError"));$("#progressModal").find(".modal-body").append($row),$row.removeClass("uploading").find(".progress-bar").removeClass("active").addClass("progress-bar-danger"),$row.parent().find(".uploading").length<1&&$("#progressModal").find(".abort").text(getLan("Close"))}else{var $row=renderFileUploadRow(file,folder);$("#progressModal").find(".modal-body").append($row);var fd=new FormData;fd.append("file",file),fd.append("folder",folder);var XHR=new XMLHttpRequest;XHR.open("POST","/chfs/upload"),uploading_xhrs.push(XHR),XHR.upload.onprogress=function(e){e.lengthComputable&&($progress=(e.loaded/e.total*100|0)+"%",$row.find(".progress-bar").css("width",$progress).text($progress))},XHR.onreadystatechange=function(){4==XHR.readyState&&(201==XHR.status?($row.removeClass("uploading").find(".progress-bar").removeClass("active").addClass("progress-bar-success").text(getLan("UploadOK")),$row.parent().find(".uploading").length<1&&($row.parent().find(".error").length<1&&window.setTimeout((function(){$("#progressModal").modal("hide")}),2e3),list())):403===XHR.status&&(res="403",$("#progressModal").modal("hide"),$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("HaveNoUploadPermission")+"</span>",autoClose:"cancelAction|2000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})),$row.parent().find(".uploading").length<1&&$("#progressModal").find(".abort").text(getLan("Close")))},XHR.send(fd)}})),res}function renderDirUploadRow(folder){return $row=$('<div class="uploading" />').append($("<h4/>").html(folder)).append($('<div class="progress"><div class="active progress-bar progress-bar-striped" role="progressbar"></div></div>'))}function renderFileUploadRow(file,folder){return $row=$('<div class="uploading" />').append($("<h4/>").html('<i class="glyphicon glyphicon-upload" /> '+file.name+" ("+formatFileSize(file.size,2)+")")).append($('<div class="progress"><div class="active progress-bar progress-bar-striped" role="progressbar"></div></div>'))}function renderFileSizeErrorRow(file,folder){return $row=$('<div class="error" />').css("color","#A00").append($("<h4/>").html('<i class="glyphicon glyphicon-remove-circle" /> '+file.name+" ("+formatFileSize(file.size,2)+")")).append($('<div class="progress"><div class="progress-bar progress-barstriped progress-bar-danger" role="progressbar" style="width:100%;">'+getLan("ExceedFileLimit")+"： "+formatFileSize(MAX_UPLOAD_SIZE,2)+"</div></div>"))}function renderErrorRow(file,errmsg){return $row=$('<div class="error" />').css("color","#A00").append($("<h4/>").html('<i class="glyphicon glyphicon-remove-circle" /> '+file.name+" ("+formatFileSize(file.size,2)+")")).append($('<div class="progress"><div class="progress-bar progress-barstriped progress-bar-danger" role="progressbar" style="width:100%;"> '+errmsg+"</div></div>"))}function renderDirErrorRow(folder,errmsg){return $row=$('<div class="error" />').css("color","#A00").append($("<h4/>").html('<i class="glyphicon glyphicon-remove-circle" /> '+folder)).append($('<div class="progress"><div class="progress-bar progress-barstriped progress-bar-danger" role="progressbar" style="width:100%;"> '+errmsg+"</div></div>"))}function onSearchGolbal(){var text=$("#searchText").val();if(""===text)""!==oldSearchText&&(list(),oldSearchText="");else if(oldSearchText=text,1!=searchMode){var $tbody=$("#filelist");$tbody.hide().empty().append('<tr><td class="text-center" colspan="6"><br/><img height="160px" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgc3Ryb2tlPSJyZ2JhKDAsMCwwLDAuNSkiIGZpbGw9Im5vbmUiIHN0cm9rZS13aWR0aD0iNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGZyb209IjAiIHRvPSI1MDIiIC8+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hhcnJheSIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIHZhbHVlcz0iMTUwLjYgMTAwLjQ7MSAyNTA7MTUwLjYgMTAwLjQiIC8+PC9jaXJjbGU+PC9zdmc+" /><br/></td></tr>').fadeIn();var settings={async:!0,crossDomain:!0,url:"/chfs/search?str="+oldSearchText,method:"GET",headers:{"cache-control":"no-cache"},processData:!1};$.ajax(settings).done((function(result){var currentWritable;$("#filelist").empty(),$("#breadcrumb").empty().html(renderBreadcrumbsSearching("/",text)),$.each(result.files,(function(index,value){$("#filelist").append(renderFileRow(value,text))})),-1!==result.currentMask.indexOf("W")?1===result.virtualRoot?$(".wrOptBtns").hide():$(".wrOptBtns").show():$(".wrOptBtns").hide(),$("#table").retablesort(),$tbody.hide().fadeIn("normal")})).fail((function(jqXHR){alert(getLan("AlertSearchResultTooMany"))}))}}$("#btnSearch").on("click",onSearchGolbal);var oldSearchText="",jc;function onSearchingInPage(){var text=$("#searchText").val();""===text?""!==oldSearchText&&(list(),oldSearchText=""):(oldSearchText=text,1==searchMode&&($("#filelist").empty(),$("#breadcrumb").empty().html(renderBreadcrumbsSearching(window.location.hash.substr(1),text)),$.each(cacheList,(function(index,value){-1!==value.name.toUpperCase().indexOf(text.toUpperCase())&&$("#filelist").append(renderFileRow(value,text))})),$("#table").retablesort()))}function renderBreadcrumbsSearching(p,t){path=decodeURIComponent(p);var base="/",len=path.split("/").length,html='<li><a href="#" onclick="list()">'+getLan("RootPath")+"</a></li>";return len>1&&"/"!=path&&(html='<li><a href="#">'+getLan("RootPath")+"</a></li>"),$.each(path.split("/"),(function(index,value){value&&(html+=len==index+1?'<li><a href="#'+base+encodeURIComponent(value)+'" onclick="list()">'+value+"</a></li>":'<li><a href="#'+base+encodeURIComponent(value)+'" >'+value+"</a></li>",base+=value+"/")})),localStorage.getItem("lan")>0?html+='<li  class="active">Search results of "'+t+'"</li>':html+='<li  class="active">搜索"'+t+'"结果</li>',html}function createNewDir(){var name=$("#inputCreatedir").val();if(!name)return $.alert(getLan("ContentCanntEmpty")),!1;jc.close();var hashval,encoded_fileurl=window.location.hash.substr(1)+"/"+encodeURIComponent(name),form=new FormData;form.append("filepath",encoded_fileurl);var settings={async:!1,crossDomain:!0,url:"/chfs/newdir",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(){list()})).fail((function(jqXHR){401===jqXHR.status?(loginStatusHandler(!1),tokenInvalideTooltip(),list()):$.confirm({theme:"bootstrap",type:"red",title:"",content:'<span class="fileitemTr">'+getLan("FailDescriptionDef")+"</span>",autoClose:"cancelAction|3000",buttons:{cancelAction:{text:getLan("Close"),action:function(){}}}})}))}function createNewDirFun(encoded_fileurl){var form=new FormData;form.append("filepath",encoded_fileurl);var settings={async:!1,crossDomain:!0,url:"/chfs/newdir",method:"POST",headers:{"cache-control":"no-cache"},processData:!1,contentType:!1,mimeType:"multipart/form-data",data:form};$.ajax(settings).done((function(){})).fail((function(jqXHR){}))}function isInputDirSupported(){var tmpInput=document.createElement("input");return"webkitdirectory"in tmpInput||"mozdirectory"in tmpInput||"odirectory"in tmpInput||"msdirectory"in tmpInput||"directory"in tmpInput}function changeSearchMode(mode){null!=mode&&(searchMode=mode,localStorage.setItem("searchMode",mode)),2==mode?($("#searchText").attr("placeholder",getLan("searchMenuGlobal")+"..."),$("#btnSearch").show()):($("#searchText").attr("placeholder",getLan("searchMenuLocal")+"..."),$("#btnSearch").hide())}$("#searchText").on("keyup",(function(e){var keynum;window.event?keynum=e.keyCode:e.which&&(keynum=e.which),13==keynum?onSearchGolbal():!keynum||keynum<=135&&keynum>=112||9==keynum||13==keynum||20==keynum||keynum<=40&&keynum>=37||(27==keynum?""!=$("#searchText").val()&&($("#searchText").val(""),list()):onSearchingInPage())})),$("#createdirBtn").on("click",(function(){jc=$.confirm({title:getLan("CreateDir"),backgroundDismiss:!0,content:'<form action="" class="formName"><div class="form-group"><input id="inputCreatedir" type="text" placeholder="'+getLan("TipDirName")+'" autofocus="aotofocus" class="name form-control"  required /></div></form>',buttons:{formSubmit:{text:getLan("Create"),btnClass:"btn-blue",keys:["enter"],action:createNewDir},cancel:{text:getLan("Cancel"),action:function(){}}},onContentReady:function(){$("#inputCreatedir").keypress((function(e){13==e.which&&createNewDir()}))}})})),!1===isInputDirSupported()&&$("#uploadDirBtn").hide();